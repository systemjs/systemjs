{"version":3,"file":"module-types.min.js","sources":["../../src/common.js","../../src/extras/module-types.js"],"sourcesContent":["import { errMsg } from './err-msg.js';\n\nexport var hasSymbol = typeof Symbol !== 'undefined';\nexport var hasSelf = typeof self !== 'undefined';\nexport var hasDocument = typeof document !== 'undefined';\n\nvar envGlobal = hasSelf ? self : global;\nexport { envGlobal as global };\n\n// Loader-scoped baseUrl and import map supported in Node.js only\nexport var BASE_URL = hasSymbol ? Symbol() : '_';\nexport var IMPORT_MAP = hasSymbol ? Symbol() : '#';\n\nexport var baseUrl;\n\nif (hasDocument) {\n  var baseEl = document.querySelector('base[href]');\n  if (baseEl)\n    baseUrl = baseEl.href;\n}\n\nif (!baseUrl && typeof location !== 'undefined') {\n  baseUrl = location.href.split('#')[0].split('?')[0];\n  var lastSepIndex = baseUrl.lastIndexOf('/');\n  if (lastSepIndex !== -1)\n    baseUrl = baseUrl.slice(0, lastSepIndex + 1);\n}\n\nif (!process.env.SYSTEM_BROWSER && !baseUrl && typeof process !== 'undefined') {\n  var cwd = process.cwd();\n  // TODO: encoding edge cases\n  baseUrl = 'file://' + (cwd[0] === '/' ? '' : '/') + cwd.replace(/\\\\/g, '/') + '/';\n}\n\nvar backslashRegEx = /\\\\/g;\nexport function resolveIfNotPlainOrUrl (relUrl, parentUrl) {\n  if (relUrl.indexOf('\\\\') !== -1)\n    relUrl = relUrl.replace(backslashRegEx, '/');\n  // protocol-relative\n  if (relUrl[0] === '/' && relUrl[1] === '/') {\n    return parentUrl.slice(0, parentUrl.indexOf(':') + 1) + relUrl;\n  }\n  // relative-url\n  else if (relUrl[0] === '.' && (relUrl[1] === '/' || relUrl[1] === '.' && (relUrl[2] === '/' || relUrl.length === 2 && (relUrl += '/')) ||\n      relUrl.length === 1  && (relUrl += '/')) ||\n      relUrl[0] === '/') {\n    var parentProtocol = parentUrl.slice(0, parentUrl.indexOf(':') + 1);\n    // Disabled, but these cases will give inconsistent results for deep backtracking\n    //if (parentUrl[parentProtocol.length] !== '/')\n    //  throw Error('Cannot resolve');\n    // read pathname from parent URL\n    // pathname taken to be part after leading \"/\"\n    var pathname;\n    if (parentUrl[parentProtocol.length + 1] === '/') {\n      // resolving to a :// so we need to read out the auth and host\n      if (parentProtocol !== 'file:') {\n        pathname = parentUrl.slice(parentProtocol.length + 2);\n        pathname = pathname.slice(pathname.indexOf('/') + 1);\n      }\n      else {\n        pathname = parentUrl.slice(8);\n      }\n    }\n    else {\n      // resolving to :/ so pathname is the /... part\n      pathname = parentUrl.slice(parentProtocol.length + (parentUrl[parentProtocol.length] === '/'));\n    }\n\n    if (relUrl[0] === '/')\n      return parentUrl.slice(0, parentUrl.length - pathname.length - 1) + relUrl;\n\n    // join together and split for removal of .. and . segments\n    // looping the string instead of anything fancy for perf reasons\n    // '../../../../../z' resolved to 'x/y' is just 'z'\n    var segmented = pathname.slice(0, pathname.lastIndexOf('/') + 1) + relUrl;\n\n    var output = [];\n    var segmentIndex = -1;\n    for (var i = 0; i < segmented.length; i++) {\n      // busy reading a segment - only terminate on '/'\n      if (segmentIndex !== -1) {\n        if (segmented[i] === '/') {\n          output.push(segmented.slice(segmentIndex, i + 1));\n          segmentIndex = -1;\n        }\n      }\n\n      // new segment - check if it is relative\n      else if (segmented[i] === '.') {\n        // ../ segment\n        if (segmented[i + 1] === '.' && (segmented[i + 2] === '/' || i + 2 === segmented.length)) {\n          output.pop();\n          i += 2;\n        }\n        // ./ segment\n        else if (segmented[i + 1] === '/' || i + 1 === segmented.length) {\n          i += 1;\n        }\n        else {\n          // the start of a new segment as below\n          segmentIndex = i;\n        }\n      }\n      // it is the start of a new segment\n      else {\n        segmentIndex = i;\n      }\n    }\n    // finish reading out the last segment\n    if (segmentIndex !== -1)\n      output.push(segmented.slice(segmentIndex));\n    return parentUrl.slice(0, parentUrl.length - pathname.length) + output.join('');\n  }\n}\n\n/*\n * Import maps implementation\n *\n * To make lookups fast we pre-resolve the entire import map\n * and then match based on backtracked hash lookups\n *\n */\n\nexport function resolveUrl (relUrl, parentUrl) {\n  return resolveIfNotPlainOrUrl(relUrl, parentUrl) || (relUrl.indexOf(':') !== -1 ? relUrl : resolveIfNotPlainOrUrl('./' + relUrl, parentUrl));\n}\n\nfunction resolveAndComposePackages (packages, outPackages, baseUrl, parentMap, parentUrl) {\n  for (var p in packages) {\n    var resolvedLhs = resolveIfNotPlainOrUrl(p, baseUrl) || p;\n    var rhs = packages[p];\n    // package fallbacks not currently supported\n    if (typeof rhs !== 'string')\n      continue;\n    var mapped = resolveImportMap(parentMap, resolveIfNotPlainOrUrl(rhs, baseUrl) || rhs, parentUrl);\n    if (!mapped) {\n      if (process.env.SYSTEM_PRODUCTION)\n        targetWarning('W1', p, rhs);\n      else\n        targetWarning('W1', p, rhs, 'bare specifier did not resolve');\n    }\n    else\n      outPackages[resolvedLhs] = mapped;\n  }\n}\n\nexport function resolveAndComposeImportMap (json, baseUrl, outMap) {\n  if (json.imports)\n    resolveAndComposePackages(json.imports, outMap.imports, baseUrl, outMap, null);\n\n  var u;\n  for (u in json.scopes || {}) {\n    var resolvedScope = resolveUrl(u, baseUrl);\n    resolveAndComposePackages(json.scopes[u], outMap.scopes[resolvedScope] || (outMap.scopes[resolvedScope] = {}), baseUrl, outMap, resolvedScope);\n  }\n\n  for (u in json.depcache || {})\n    outMap.depcache[resolveUrl(u, baseUrl)] = json.depcache[u];\n  \n  for (u in json.integrity || {})\n    outMap.integrity[resolveUrl(u, baseUrl)] = json.integrity[u];\n}\n\nfunction getMatch (path, matchObj) {\n  if (matchObj[path])\n    return path;\n  var sepIndex = path.length;\n  do {\n    var segment = path.slice(0, sepIndex + 1);\n    if (segment in matchObj)\n      return segment;\n  } while ((sepIndex = path.lastIndexOf('/', sepIndex - 1)) !== -1)\n}\n\nfunction applyPackages (id, packages) {\n  var pkgName = getMatch(id, packages);\n  if (pkgName) {\n    var pkg = packages[pkgName];\n    if (pkg === null) return;\n    if (id.length > pkgName.length && pkg[pkg.length - 1] !== '/') {\n      if (process.env.SYSTEM_PRODUCTION)\n        targetWarning('W2', pkgName, pkg);\n      else\n        targetWarning('W2', pkgName, pkg, \"should have a trailing '/'\");\n    }\n    else\n      return pkg + id.slice(pkgName.length);\n  }\n}\n\nfunction targetWarning (code, match, target, msg) {\n  console.warn(errMsg(code, process.env.SYSTEM_PRODUCTION ? [target, match].join(', ') : \"Package target \" + msg + \", resolving target '\" + target + \"' for \" + match));\n}\n\nexport function resolveImportMap (importMap, resolvedOrPlain, parentUrl) {\n  var scopes = importMap.scopes;\n  var scopeUrl = parentUrl && getMatch(parentUrl, scopes);\n  while (scopeUrl) {\n    var packageResolution = applyPackages(resolvedOrPlain, scopes[scopeUrl]);\n    if (packageResolution)\n      return packageResolution;\n    scopeUrl = getMatch(scopeUrl.slice(0, scopeUrl.lastIndexOf('/')), scopes);\n  }\n  return applyPackages(resolvedOrPlain, importMap.imports) || resolvedOrPlain.indexOf(':') !== -1 && resolvedOrPlain;\n}\n","import { resolveUrl } from '../common.js';\n\n/*\n * Loads JSON, CSS, Wasm module types based on file extension\n * filters and content type verifications\n */\n(function(global) {\n  var systemJSPrototype = global.System.constructor.prototype;\n\n  var moduleTypesRegEx = /^[^#?]+\\.(css|html|json|wasm)([?#].*)?$/;\n  systemJSPrototype.shouldFetch = function (url) {\n    return moduleTypesRegEx.test(url);\n  };\n\n  var jsonContentType = /^application\\/json(;|$)/;\n  var cssContentType = /^text\\/css(;|$)/;\n  var wasmContentType = /^application\\/wasm(;|$)/;\n\n  var fetch = systemJSPrototype.fetch;\n  systemJSPrototype.fetch = function (url, options) {\n    return fetch(url, options)\n    .then(function (res) {\n      if (options.passThrough)\n        return res;\n\n      if (!res.ok)\n        return res;\n      var contentType = res.headers.get('content-type');\n      if (jsonContentType.test(contentType))\n        return res.json()\n        .then(function (json) {\n          return new Response(new Blob([\n            'System.register([],function(e){return{execute:function(){e(\"default\",' + JSON.stringify(json) + ')}}})'\n          ], {\n            type: 'application/javascript'\n          }));\n        });\n      if (cssContentType.test(contentType))\n        return res.text()\n        .then(function (source) {\n          source = source.replace(/url\\(\\s*(?:([\"'])((?:\\\\.|[^\\n\\\\\"'])+)\\1|((?:\\\\.|[^\\s,\"'()\\\\])+))\\s*\\)/g, function (match, quotes, relUrl1, relUrl2) {\n            return 'url(' + quotes + resolveUrl(relUrl1 || relUrl2, url) + quotes + ')';\n          });\n          return new Response(new Blob([\n            'System.register([],function(e){return{execute:function(){var s=new CSSStyleSheet();s.replaceSync(' + JSON.stringify(source) + ');e(\"default\",s)}}})'\n          ], {\n            type: 'application/javascript'\n          }));\n        });\n      if (wasmContentType.test(contentType))\n        return (WebAssembly.compileStreaming ? WebAssembly.compileStreaming(res) : res.arrayBuffer().then(WebAssembly.compile))\n        .then(function (module) {\n          if (!global.System.wasmModules)\n            global.System.wasmModules = Object.create(null);\n          global.System.wasmModules[url] = module;\n          // we can only set imports if supported (eg early Safari doesnt support)\n          var deps = [];\n          var setterSources = [];\n          if (WebAssembly.Module.imports)\n            WebAssembly.Module.imports(module).forEach(function (impt) {\n              var key = JSON.stringify(impt.module);\n              if (deps.indexOf(key) === -1) {\n                deps.push(key);\n                setterSources.push('function(m){i[' + key + ']=m}');\n              }\n            });\n          return new Response(new Blob([\n            'System.register([' + deps.join(',') + '],function(e){var i={};return{setters:[' + setterSources.join(',') +\n            '],execute:function(){return WebAssembly.instantiate(System.wasmModules[' + JSON.stringify(url) +\n            '],i).then(function(m){e(m.exports)})}}})'\n          ], {\n            type: 'application/javascript'\n          }));\n        });\n      return res;\n    });\n  };\n})(typeof self !== 'undefined' ? self : global);\n"],"names":["resolveIfNotPlainOrUrl","relUrl","parentUrl","indexOf","replace","slice","length","pathname","parentProtocol","segmented","lastIndexOf","output","segmentIndex","i","push","pop","join","baseUrl","document","baseEl","querySelector","href","location","lastSepIndex","split","global","systemJSPrototype","System","constructor","prototype","moduleTypesRegEx","shouldFetch","url","test","jsonContentType","cssContentType","wasmContentType","fetch","options","then","res","passThrough","ok","contentType","headers","get","json","Response","Blob","JSON","stringify","type","text","source","match","quotes","relUrl1","relUrl2","WebAssembly","compileStreaming","arrayBuffer","compile","module","wasmModules","Object","create","deps","setterSources","Module","imports","forEach","impt","key","self"],"mappings":"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"}